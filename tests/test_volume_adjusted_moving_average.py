import unittest
import numpy as np

from tests.sample_data import SampleData
from pyti import volume_adjusted_moving_average


class TestVolumeAdjustedMovingAverage(unittest.TestCase):
    def setUp(self):
        """Create data to use for testing."""
        self.data = SampleData().get_sample_close_data()
        self.volume = SampleData().get_sample_volume()

        self.vama_period_6_expected = [np.nan, np.nan, np.nan, np.nan, np.nan,
        1478.9191875054275, 1485.927186808339, 1481.5016007215124,
        1366.7993111951894, 1138.8694586412714, 1104.5954746648379,
        946.13218234680642, 922.69615745159228, 860.19234823594797,
        851.01270826797952, 814.52285941994569, 809.25274879392748,
        784.37148213332409, 767.63455656795804, 811.03606148752976,
        843.21832305088628, 837.16612745364034, 870.76143285494197,
        915.14630307187133, 912.57722758238197, 853.85373491494772,
        866.79378217966894, 867.49811110979647, 866.11607176770769,
        863.5489849618649, 871.46180722287988, 887.95647051455398,
        852.32426551175479, 883.44731862017727, 919.04705742390377,
        921.41424015751136, 954.54602411468341, 991.66033186814582,
        1115.2830631048744, 1198.0811152077529, 1410.0360135410599,
        1688.4865741012773, 1917.1424186877423, 1918.215991981376,
        1863.7584773034105, 1927.1044736459551, 1683.7393249812376,
        1377.4150362863936, 1092.0562540338792, 1066.3837072149215,
        1021.3411547574237, 890.20747328187588, 888.356659646195,
        898.26650178239595, 939.43758775767458, 1004.7245110554386,
        1007.3387471873044, 1025.2579322831325, 1097.1247314592636,
        1159.1093366126613, 1117.9856657734301, 1022.656119613738,
        978.87751023106409, 889.88464891293279, 794.88497827399135,
        764.4152968456541, 790.89402217758141, 796.51098752736198,
        988.95246020718866, 1108.2127792905665, 1185.9608029702306,
        1260.7753536472812, 1298.8107370130183, 1371.5779119720773,
        1252.6776082892834, 1275.7345100594448, 1264.0660910988249,
        1213.205355799653, 1221.8284473877932, 1334.4140503461745,
        1413.5084939839417, 1364.267853677329, 1462.8134739920863,
        1338.5495082201121, 1292.7409830621648, 1120.3240028607488,
        1042.070664276355, 1066.6367277768802, 945.90523804624581,
        1081.45407292, 1269.747257474032, 1533.9443831606586,
        1760.6716632526666, 2237.3265316109864, 2421.8750893134115,
        2420.4617394966749, 2314.0598765661589, 2119.8674343893481,
        1959.3815471892437, 1550.0654801862522, 1464.6625306458172,
        1520.5901717759809, 1795.2756210211048, 1907.5933571913313,
        1860.944723016886, 1805.126768052927, 1698.1865657801293,
        1622.2922744439393, 1270.0950505698008, 1093.3852208107576,
        1136.6440474786677, 1034.0660867815934, 988.69422130572536,
        953.29818762303705, 898.57477175906968, 920.74196327817174,
        833.27760880848825, 841.336106693754, 836.30404073311945,
        815.09746179658714, 848.88045047538014, 818.06047207122549,
        827.3865324195159, 841.57797918328015, 875.12940427704518,
        886.40358446891844, 904.25282780430268]

        self.vama_period_8_expected = [np.nan, np.nan, np.nan, np.nan, np.nan,
        np.nan, np.nan, 1408.8543552519286, 1375.7604268867276,
        1324.5505796637972, 1235.1339565915534, 1050.6618869955378,
        1049.1192141116881, 944.80922579981882, 899.57456798145813,
        824.31652368762207, 816.97403479060688, 784.78840461457708,
        796.39852553902801, 843.48713515536122, 839.96619218092849,
        807.04685810089143, 831.78557823082872, 860.25598735352139,
        873.89188463036885, 895.59882474157894, 914.33561138971174,
        849.39339531759163, 848.95888976844481, 880.04313048468998,
        874.4171654063224, 875.20645032359084, 869.14588983674128,
        871.58858309651373, 888.1488462016207, 920.48022727047601,
        940.73962966655426, 971.28996050330147, 1052.0118317482372,
        1104.1820666164131, 1306.4326572235996, 1524.259668881301,
        1689.3111506144332, 1718.8912743712001, 1733.9211716397826,
        1805.76517294977, 1732.7748536308718, 1658.7601096902813,
        1450.8263309840481, 1252.3141242064335, 1062.0702236920436,
        1034.7587839251446, 1001.2234903879599, 887.13163079261199,
        892.6000280663759, 972.79623028321737, 998.53209355711249,
        1003.9144527263028, 1058.0611729143397, 1088.808028290701,
        1064.8217826618022, 1066.0884436567239, 1028.1120354121547,
        917.78455611942354, 898.72084622935495, 893.17605171259197,
        835.14875070054063, 794.1396818427495, 931.3371312374735,
        981.95205087704494, 1054.0333157837299, 1171.3440802633534,
        1213.0930697548106, 1249.511643187567, 1277.6748208212503,
        1341.3696927761073, 1260.3685389524574, 1250.0885126451683,
        1239.9938030679825, 1304.7406657117369, 1363.6981385494425,
        1335.8871490550457, 1417.9704382295595, 1297.1997612656689,
        1261.4999720404876, 1235.0796510075586, 1228.8798012158638,
        1135.0541571280751, 1067.2679962762875, 1085.0894256976721,
        1116.7003096519468, 1381.6258072129685, 1579.8278113587401,
        1972.8060536907533, 2102.1213150540802, 2100.4581844875179,
        2142.8162885418819, 2160.4358283149795, 2097.0535286451486,
        1984.8968764599485, 1880.1144655989433, 1562.9059146112641,
        1672.8666873226514, 1775.7845415859722, 1757.2171634831939,
        1748.8413767076324, 1684.2182295421076, 1617.0760103045293,
        1526.9410772656393, 1455.3808283620544, 1263.2434833263662,
        1093.695923900329, 1030.030353258737, 978.20457498211192,
        927.23223174984457, 929.21809498772882, 935.63040200538171,
        904.6590883125765, 804.77534819957566, 813.97810624335727,
        822.37190362708566, 827.78980832387003, 882.23922250071632,
        845.28610024140767, 836.16419480099341, 847.77871457473054,
        873.33349393047308]

        self.vama_period_10_expected = [np.nan, np.nan, np.nan, np.nan, np.nan,
        np.nan, np.nan, np.nan, np.nan, 1297.8229874996732, 1268.6359200655111,
        1216.8482981427048, 1164.6452517636903, 1028.6975808282014,
        1005.3373312035613, 899.18519064838404, 862.63125725686439,
        798.57022698979188, 805.1463989873514, 831.9975425359562,
        848.51104023519042, 833.80555771248441, 831.47042249887397,
        831.54259989134607, 842.08511057599299, 855.59606783295749,
        883.0356602666352, 883.6815350983677, 890.55933161872395,
        863.05035397594725, 859.03120107918915, 886.0702736695057,
        871.97335986072301, 864.66214442735122, 894.44122952363671,
        903.58665712148536, 911.68254624019778, 960.56760612451512,
        1021.473554663023, 1065.381422574884, 1217.5857533145449,
        1383.9047192735197, 1550.5734381457903, 1581.4288101412344,
        1588.3004065907273, 1668.7955626679504, 1655.1017338344773,
        1615.357541924468, 1536.6373527031933, 1502.4103653455356,
        1355.0834913205458, 1189.8281021763094, 1037.8302784095483,
        1003.3878478050798, 982.0448189757517, 948.98238779122585,
        949.2431446441858, 978.53383977435317, 1040.8713648647793,
        1059.0232254437237, 1040.0315255853552, 1028.4515755903431,
        1003.5556549951074, 973.50472805267532, 954.13979917456948,
        914.83769691785278, 910.16469057952168, 891.20340873688076,
        938.65229224386235, 942.96679365941839, 994.92488149264955,
        1057.7092373379787, 1102.1246266486942, 1180.2193665723676,
        1213.3278702530376, 1249.758321587693, 1278.8281228453959,
        1307.7258583013536, 1241.850218957057, 1315.9401292057323,
        1349.8564848612643, 1311.8538216057216, 1377.2297650328367,
        1287.9088160501744, 1265.8882438207859, 1222.6938248865147,
        1216.6592287677822, 1223.9126447920576, 1211.6758394279082,
        1136.1328295944695, 1179.6315019148399, 1324.4997425765125,
        1395.3741423241304, 1763.1788588265822, 1889.1563031786561,
        1916.215471576025, 1942.8250292887228, 1956.4381665439935,
        2003.4599278099292, 2044.3457031863334, 2006.1054670817273,
        1908.2029447452187, 1963.5874039497855, 1758.5982618922003,
        1666.9017080320132, 1675.1447203200848, 1636.5814806101096,
        1609.6578487779732, 1550.0155059781198, 1484.5901062669034,
        1470.0906181317237, 1383.2302693234524, 1152.632640780882,
        1037.0807470369969, 972.59353522343008, 953.95922340205038,
        951.14524394873911, 914.6565686733411, 892.35803487887301,
        870.10809162849478, 799.9353770214575, 824.35585457582965,
        854.3606306170135, 847.62444360948689, 878.29081438965818,
        849.50506434294255, 842.52050841894618]

    def test_vama_period_6(self):
        period = 6
        vama = volume_adjusted_moving_average.volume_adjusted_moving_average(self.data, self.volume, period)
        np.testing.assert_array_equal(vama, self.vama_period_6_expected)

    def test_vama_period_8(self):
        period = 8
        vama = volume_adjusted_moving_average.volume_adjusted_moving_average(self.data, self.volume, period)
        np.testing.assert_array_equal(vama, self.vama_period_8_expected)

    def test_vama_period_10(self):
        period = 10
        vama = volume_adjusted_moving_average.volume_adjusted_moving_average(self.data, self.volume, period)
        np.testing.assert_array_equal(vama, self.vama_period_10_expected)

    def test_vama_invalid_data(self):
        self.data.append(1)
        period = 6
        with self.assertRaises(Exception) as cm:
            volume_adjusted_moving_average.volume_adjusted_moving_average(self.data, self.volume, period)
        expected = ("Error: mismatched data lengths, check to ensure that all input data is the same length and valid")
        self.assertEqual(str(cm.exception), expected)

    def test_vama_invalid_period(self):
        period = 128
        with self.assertRaises(Exception) as cm:
            volume_adjusted_moving_average.volume_adjusted_moving_average(self.data, self.volume, period)
        expected = "Error: data_len < period"
        self.assertEqual(str(cm.exception), expected)
