import unittest
import numpy as np

from sample_data import SampleData
from technical_indicators import average_true_range_percent


class TestAverageTrueRangePercent(unittest.TestCase):
    def setUp(self):
        """Create data to use for testing."""
        self.close_data = SampleData().get_sample_close_data()

        self.atr_period_6_expected = [np.nan, np.nan, np.nan, np.nan, np.nan,
        np.nan, np.nan, np.nan, np.nan, np.nan, 1.189235578986088,
        1.1523554512220486, 1.1278525931922065, 1.1546224092640733,
        1.1660380962839427, 1.465357027466913, 1.7831881894142803,
        2.3561329806184581, 2.6708206943371162, 3.2466120755686263,
        3.3784546239726194, 3.3564621491521369, 3.2791301980772869,
        3.2778865256303997, 3.2875442760137483, 3.2810676552694984,
        3.0012226151326331, 2.7233687488098011, 2.5062178027349966,
        2.2774730211707057, 2.1306723573292059, 2.0231111698118602,
        2.4639048069082961, 2.7153248878733027, 2.9415900735797162,
        3.457810754140358, 4.0649377298167551, 4.6505410623216603,
        4.8377005165939497, 4.7010401069556149, 4.5393599025684406,
        4.3416370097985153, 4.1909513300536148, 4.2334214723046726,
        4.2994054993189517, 4.244940888039114, 3.9739765293353395,
        3.7984682769968288, 3.5821945386433534, 3.3670297979975179,
        3.0716656116914933, 2.8662794746678979, 3.0289151976072608,
        2.9969860158644486, 2.9760460695914741, 2.9289691288143112,
        2.8058612079021295, 2.531556736800797, 2.4252616931651314,
        2.2944282121480746, 2.1964244646895756, 2.1062390474088564,
        2.0476395013091233, 1.7748361482743773, 1.558061265928161,
        1.4856536290363038, 1.4497927574913438, 1.4352358669002241,
        1.4299189209362686, 1.4620245560453282, 1.5102324721906708,
        1.6037560819721852, 1.7746556607866535, 1.9035211913074188,
        2.0074893237351557, 2.0029061884391339, 1.9371230450535861,
        1.8548689401186171, 1.8355003791530897, 1.8003331288038178,
        1.8931540501005137, 1.9806126301955329, 2.0822871750835494,
        2.1587399768435973, 2.1858863683758751, 2.1992145124735707,
        2.2042274600601361, 1.9903770888121171, 1.7884145439862129,
        1.6114041799566228, 1.4484765868823961, 1.3246773786986321,
        1.2742050031825125, 1.2954614666198452, 1.3205653492681662,
        1.2899663246832471, 1.2549300623614186, 1.197182571361552,
        1.1407924958934879, 1.1008057151615109, 1.0691600335312013,
        0.96093180817465618, 0.8664228618513774, 0.96576000827190556,
        1.0376009347982038, 1.0764636750622629, 1.0975646487156931,
        1.2540789775805865, 1.8437302592780713, 2.3966411426581957,
        2.9608753508340118, 3.423129872873973, 3.5883658875288575,
        3.2621236585354922, 2.8752781621886734, 2.5375908547247414,
        2.2497857207671332, 2.4554221153770741, 2.5315780677888444,
        2.7585119334766222, 2.8337261439349244, 2.9745745527293854,
        2.9297633150649793, 3.1503331074467429, 3.212529671651343,
        3.3456605064982394, 3.2905345939522999]

        self.atr_period_8_expected = [np.nan, np.nan, np.nan, np.nan, np.nan,
        np.nan, np.nan, np.nan, np.nan, np.nan, np.nan, np.nan, np.nan, np.nan,
        1.4180925319661521, 1.6202706653923087, 1.841626084216712,
        2.3148854933979575, 2.6901735299560841, 3.2282310244121613,
        3.563083750221574, 3.7982037524565646, 3.7546634785721498,
        3.7323220510040827, 3.6914812566023922, 3.6379421910796386,
        3.5587099948976539, 3.5146074512555128, 3.3287123687477114,
        3.0890446215528855, 2.8876354582425368, 2.7197748421358332,
        2.9957755812395579, 3.0918928706039539, 3.2034849639589456,
        3.5276212120453141, 3.966956483762083, 4.4299504506994678,
        4.9204122583250323, 5.2383912644056707, 5.1851996464032979,
        4.932742857755783, 4.7691968174243575, 4.7104555366635612,
        4.7209742731687623, 4.7303883735587853, 4.8062829601892965,
        4.8770730470382375, 4.786932261959409, 4.5940745527992979,
        4.2712108603228502, 4.0426131987685459, 4.0492483355737523,
        4.0367369950162013, 4.0266065104420958, 3.8442225538659289,
        3.7281167468319927, 3.5969454050028618, 3.5246336505629778,
        3.284458875889694, 3.0905268522063674, 2.9085376948755512,
        2.7680000175672808, 2.6252958389957679, 2.5159579023784877,
        2.3306698200373246, 2.197229157817036, 2.1031142412351342,
        2.0360589047455808, 2.0179156129481299, 1.9962963663924316,
        2.010951331437755, 2.0924060195314591, 2.1470029836845206,
        2.1917407916945137, 2.3469908853240153, 2.4897011782528256,
        2.4061646855957806, 2.3351333133106342, 2.230276487867163,
        2.2408826576806198, 2.2629816480494824, 2.3143268379407238,
        2.3476629061550369, 2.3674721414695301, 2.374550948419341,
        2.352947385951865, 2.351910270923812, 2.3499424768917128,
        2.1608124958654997, 1.9893774678680414, 1.851281037063653,
        1.7449273052921825, 1.6992086324724789, 1.7010190503124114,
        1.7165471586824528, 1.6847862993283729, 1.634206765480277,
        1.6018940222973894, 1.5378290457744153, 1.4602893936269465,
        1.3946452189065861, 1.3308265877060355, 1.3548427859710599,
        1.3588718015896448, 1.3628282348400853, 1.366672736225832,
        1.4652930518912579, 1.9954910663104219, 2.4924846364624273,
        2.9075743465183366, 3.261046890754919, 3.5616237891147984,
        3.90750519846529, 4.0167530144468557, 3.7380084557614692,
        3.4172149917994443, 3.4633450788377629, 3.4315003707559737,
        3.5392138594642271, 3.5549856117004808, 3.6469399018473312,
        3.8534409701377266, 4.2338496480817174, 4.1988778641402176,
        4.2434190220063472, 4.1710674834485006]

        self.atr_period_10_expected = [np.nan, np.nan, np.nan, np.nan, np.nan,
        np.nan, np.nan, np.nan, np.nan, np.nan, np.nan, np.nan, np.nan, np.nan,
        np.nan, np.nan, np.nan, np.nan, 2.7186399732723401, 3.1897417785103217,
        3.5720003140004968, 3.8243907563025203, 3.9543745819821638,
        4.14966762493796, 4.1567426181748255, 4.0952266131322199,
        3.9774055776649679, 3.9005313973245412, 3.8740200478862201,
        3.7608260441925863, 3.5854123216136311, 3.4311560353359063,
        3.6153121546372664, 3.6024786252080254, 3.6288964245394193,
        3.8135185789216313, 4.1288199078722743, 4.4946788398373076,
        4.9058770233302322, 5.1603606395261004, 5.3529137258920727,
        5.445088414102206, 5.3705628277712574, 5.2556944589666976,
        5.2134596631940662, 5.1637259824115125, 5.1838624309051387,
        5.2791302264027182, 5.4683909738033964, 5.5120358790272803,
        5.2939445953362574, 5.1115798997200201, 5.0421404425151195,
        4.9375845577616317, 4.8404418486438017, 4.7051409062810361,
        4.6372061837056462, 4.432524791048948, 4.3857899092249255,
        4.2640474851745038, 4.1058549092701808, 3.8557539531622109,
        3.6529206682490591, 3.4440864860929081, 3.2769697024906264,
        3.0924922423109011, 2.9510365216850634, 2.8116170875265167,
        2.6711372457210696, 2.5919272122011878, 2.5577863035116755,
        2.5192993537277801, 2.5383732677201931, 2.5348033661300149,
        2.5286463785226361, 2.6292596767417997, 2.7167970175342209,
        2.7550799044874084, 2.8604804641492096, 2.7345280164604793,
        2.6868520965130984, 2.6599028030438059, 2.6726181141515055,
        2.6688858692968398, 2.6540997015450611, 2.6291880295217065,
        2.6002059836457319, 2.5941937083210851, 2.5700615442727237,
        2.535308379517017, 2.5013101557717698, 2.339251886928428,
        2.220771727829487, 2.1516737476710861, 2.1053990350980456,
        2.0811011642229702, 2.0438008059797284, 2.0320916025384799,
        2.0069284521724975, 1.9527756899172914, 1.9026101646939952,
        1.8269161484400693, 1.7312268984763945, 1.7180069351756679,
        1.6836641042431297, 1.6535040163297123, 1.6269651536833674,
        1.6987531568883674, 2.136689374875739, 2.5300549519920104,
        2.9404650888832795, 3.2991327451858363, 3.5341944123641578,
        3.8180814412294013, 4.0387527580573863, 4.2834486458410144,
        4.3625514336653879, 4.4307414948453614, 4.3447237418697808,
        4.3526388061920898, 4.3079912365795749, 4.3466474073655306,
        4.510844263106514, 4.8245544999792642, 4.9825704530372255,
        5.1956243905869313, 5.0759722759771062]

    def test_atrp_period_6(self):
        period = 6
        atrp = average_true_range_percent.average_true_range_percent(self.close_data, period)
        np.testing.assert_array_equal(atrp, self.atr_period_6_expected)

    def test_atrp_period_8(self):
        period = 8
        atrp = average_true_range_percent.average_true_range_percent(self.close_data, period)
        np.testing.assert_array_equal(atrp, self.atr_period_8_expected)

    def test_atrp_period_10(self):
        period = 10
        atrp = average_true_range_percent.average_true_range_percent(self.close_data, period)
        np.testing.assert_array_equal(atrp, self.atr_period_10_expected)

    def test_atrp_invalid_period(self):
        period = 128
        with self.assertRaises(Exception):
            average_true_range_percent.average_true_range_percent(self.data, period)
