import unittest
import numpy as np

from sample_data import SampleData
from technical_indicators import price_channels


class TestPriceChannels(unittest.TestCase):
    def setUp(self):
        """Create data to use for testing."""
        self.data = SampleData().get_sample_close_data()

        self.upc_period_6_upper_percent_6_expected = [np.nan, np.nan, np.nan,
        np.nan, np.nan, 855.44896672547645, 857.93160487728392,
        860.26886622755433, 860.9170045283463, 860.20237165372851,
        861.81979779267613, 863.67019992942846, 863.98447002273974,
        861.47145671606688, 860.34300201913288, 854.67319662824457,
        849.0616652630755, 839.60965511252255, 833.68894419744367,
        824.99941237747987, 818.6753096643929, 818.85415713165537,
        823.88921261271878, 826.92014621657665, 827.03822778953986,
        827.34170920567726, 829.65995010977804, 830.71026897592753,
        827.74776077001502, 829.35973355681006, 828.612119787501,
        826.45043335293667, 816.96575483023616, 816.67167423351384,
        819.85368318826954, 830.48967419038661, 840.60509759664421,
        844.57902849525624, 841.12559703599152, 838.18006125617512,
        837.85576322041868, 842.40867163804603, 846.90800384223326,
        853.95697620559872, 859.19092527248517, 864.53779222535877,
        870.32061565906076, 876.17094998823814, 876.06562822865203,
        874.69368937896968, 875.72308793617208, 874.28231225593981,
        867.83765584176297, 862.11854150003956, 858.39360441856832,
        858.5312988590922, 857.60807526464384, 858.8148756645495,
        855.6556141535325, 854.33059420528514, 852.76217675448936,
        851.83001011134638, 850.4245507253197, 850.49249341723532,
        850.66941380067442, 853.27721785462256, 855.45973358425465,
        854.1244589900416, 857.58161536893283, 860.2260720418725,
        858.36713454873382, 854.86165395593196, 850.79350021171501,
        849.16348652081876, 848.56674238610526, 844.33326525523421,
        841.20817426095834, 842.74679713400781, 840.43829388379208,
        843.68477910687693, 847.65107460597505, 850.99416108758737,
        849.5687621814476, 846.17181376930932, 843.68369691445173,
        841.96334218223171, 841.85768192582145, 840.87279538932023,
        840.01593109464443, 840.46084974123744, 841.89476883478414,
        842.9487110091743, 844.46358196110725, 846.74887085391686,
        849.40274496981112, 849.71440495961735, 851.46420891554965,
        853.07804249980381, 854.50717339057485, 855.48547451187983,
        855.70768718340787, 855.27681958362757, 855.34151943856364,
        851.9565354034346, 850.06858006743516, 849.12567731906211,
        848.7853984513448, 845.29400111346365, 833.81568081627847,
        824.71430662197133, 816.62715016074662, 810.74954948639561,
        807.12789154708685, 803.28546863875169, 802.65610849604036,
        801.10435635144677, 800.12299462871488, 793.29190866070746,
        788.39029885125058, 782.90783701089936, 779.92614773386663,
        776.11213071434179, 770.10773440759044, 762.95982039912167,
        758.44348252175985, 754.085766874461, 752.70449868658363]

        self.upc_period_8_upper_percent_3_expected = [np.nan, np.nan, np.nan,
        np.nan, np.nan, np.nan, np.nan, 834.17136370691765, 835.4817906129191,
        835.42887978229669, 836.86338829735166, 838.38140377552452,
        838.96355098052891, 837.38354107113594, 836.47509156565445,
        831.88840467052137, 827.43870018008192, 820.03110101757102,
        814.60313875805764, 806.6655998486184, 800.54785267441184,
        799.10537437124492, 801.51224359075388, 802.92503039853636,
        802.67748394239356, 802.70896091713109, 804.24693048705637,
        805.87727303335225, 804.81631393738326, 806.2753675603725,
        805.29700653359055, 803.39140544462862, 796.30878230652831,
        795.73967978583721, 797.34165245374174, 805.28102783706436,
        813.45737083441554, 816.82650011444707, 814.13425075632381,
        812.49893736609602, 813.65001035256239, 818.39810686897044,
        822.95694277619293, 828.16023261569148, 831.39701621608037,
        835.52200596926343, 841.17571024538995, 847.43464091603641,
        848.99539690753068, 848.96331917147518, 850.22491131387028,
        849.38428291586399, 844.93695639281475, 840.71782023992318,
        837.07056222415054, 836.01165777566189, 835.02003040053194,
        835.55046255327534, 832.21255108978846, 830.44094230926953,
        829.09260342383152, 828.53545341987785, 827.48360055460671,
        827.36588011344395, 826.97690366759025, 828.47252872719537,
        830.28924369039487, 829.48297077879056, 832.17464909376463,
        834.47460296936958, 833.46279947487687, 831.15811985895573,
        828.25565343772553, 826.4174133771653, 825.82551535932703,
        822.80481118121065, 819.55984385604086, 819.67018347740691,
        817.40981969911968, 819.63264958519858, 822.87793912905249,
        825.31866911011036, 824.15489817837727, 822.18530082975337,
        820.3053385706155, 819.03274424143933, 819.43960396184002,
        818.56068316321159, 817.18738673244309, 816.72605261695776,
        817.55206436858407, 818.48325600017938, 819.97593411687512,
        821.88291577568987, 823.93372433898253, 824.50290795473541,
        826.27418188590605, 827.85850339913839, 829.28885355916759,
        830.46524843359487, 831.017738417131, 830.74310318300127,
        830.88427842494707, 828.58554803460243, 827.07017443557095,
        826.17011036257804, 825.64606990482264, 822.69111811057508,
        813.68939423670793, 805.74491765927837, 798.36401770671171,
        792.9315601895612, 789.11234521992446, 784.81232356148519,
        782.14447165757019, 779.43933080316685, 778.18234103012946,
        772.69822782577739, 768.63062970512794, 763.80128516726074,
        760.78361006314071, 757.20555674381046, 751.8385981988215,
        745.01394764005704, 740.16523961926328, 735.93759990051501,
        734.05996699129219]

        self.lpc_period_6_lower_percent_6_expected = [np.nan, np.nan, np.nan,
        np.nan, np.nan, 758.60568747353557, 760.80727224966677,
        762.8799379753782, 763.45470212891087, 762.82097108915536,
        764.25529238218451, 765.89621503175727, 766.17490737865592,
        763.94638614443659, 762.9456810358347, 757.91774040617906,
        752.94147674272733, 744.55950547714258, 739.30906372226139,
        731.60325248568972, 725.99508592880125, 726.15368651297729,
        730.61873571316562, 733.30654475809627, 733.41125860581838,
        733.68038363522305, 735.73618217282205, 736.66759701638841,
        734.04046709793784, 735.46995239943533, 734.80697415118004,
        732.89000693562298, 724.47906560417164, 724.21827715047448,
        727.04005867638989, 736.47197522543718, 745.44225635928808,
        748.96630828824607, 745.90383133380362, 743.29175243472127,
        743.00416738414481, 747.04165220732386, 751.03162604877275,
        757.28260154081386, 761.92402807182634, 766.66558933192186,
        771.79375350897828, 776.98178583862614, 776.88838729710642,
        775.67176227946368, 776.58462515094493, 775.30695615149375,
        769.59188348231794, 764.52021604720471, 761.21696995608875,
        761.3390763467421, 760.52036863091041, 761.59055011761927,
        758.78894085313254, 757.61392316317722, 756.22306240492446,
        755.39642406100529, 754.15007328471734, 754.21032435113318,
        754.3672160119188, 756.67979696542, 758.61523544264094,
        757.43112401003691, 760.49690419509136, 762.84198841449063,
        761.19349667529207, 758.08486294205284, 754.47725490472828,
        753.03177106563169, 752.5025828706971, 748.74836730181141,
        745.9770601936799, 747.34149934525215, 745.29433608562681,
        748.17329467968329, 751.69057559397788, 754.65519945503024,
        753.39116646279297, 750.37877824825534, 748.17233499960798,
        746.64673740688465, 746.55303868893589, 745.67964874147253,
        744.91978795185446, 745.31433844977653, 746.58592707990283,
        747.52055504587156, 748.86393117305727, 750.89050811573759,
        753.24394365247383, 753.52032137928325, 755.07203432133645,
        756.50316976397698, 757.7705122520191, 758.63806230298769,
        758.83511882302196, 758.45302868736769, 758.5104040304243,
        755.50862573512109, 753.83440119187628, 752.99824215086642,
        752.69648541911704, 749.60034061005251, 739.4214527993413,
        731.35042285344628, 724.17879353877515, 718.96658162001108,
        715.75492269269967, 712.3474910570061, 711.78937923233752,
        710.41329714184894, 709.54303297263391, 703.48527749157063,
        699.138566905826, 694.27676112287304, 691.63262157531562,
        688.250380067435, 682.92572673880659, 676.58701054261735,
        672.58195619854166, 668.71756685093703, 667.49266864659296]

        self.lpc_period_8_lower_percent_3_expected = [np.nan, np.nan, np.nan,
        np.nan, np.nan, np.nan, np.nan, 785.57885708321373, 786.81294844129263,
        786.76311979497837, 788.11406470721465, 789.54365209928039,
        790.09188781661464, 788.60391731941934, 787.74838720260652,
        783.42888595185013, 779.23838754823237, 772.26229901654733,
        767.15052873331638, 759.6753707312231, 753.91399717881495,
        752.55554673796848, 754.82220998352557, 756.15269853066047,
        755.91957225642886, 755.9492156209875, 757.39759473052879,
        758.93296586636086, 757.93381021287541, 759.30787042093323,
        758.38650129862413, 756.59190609833945, 749.92186294886653,
        749.38591203132239, 750.89456590303826, 758.37145339995368,
        766.07150457221655, 769.2443738941879, 766.70895459576127,
        765.1689021797215, 766.25292237085966, 770.72443074068087,
        775.01770339117195, 779.91788896817548, 782.96612206757072,
        786.85082115551984, 792.17518343497875, 798.06951620248083,
        799.53935436922779, 799.50914523915617, 800.69724657713982,
        799.90558682367771, 795.71732786507789, 791.74396663371408,
        788.30917024992823, 787.31194955572028, 786.37808688205439,
        786.87762007444371, 783.73415005543177, 782.06574178639949,
        780.79594691370528, 780.27125224978784, 779.28067236695961,
        779.16980942722387, 778.80349180345866, 780.21199307318398,
        781.92287998027473, 781.16357442274443, 783.69845594267144,
        785.86443192261015, 784.91156843750537, 782.7411420030943,
        780.00775129572196, 778.2765931804372, 777.71917465878369,
        774.87443383084883, 771.81849372850445, 771.9224057991114,
        769.79371369722912, 771.88705834722577, 774.94330189823381,
        777.24185343379315, 776.14587498352023, 774.29101146102983,
        772.52056156650201, 771.32209894582138, 771.70525809998526,
        770.8775365711798, 769.58423799074728, 769.14977770723203,
        769.92767226944329, 770.80461972832427, 772.2103457217172,
        774.00624107030978, 775.93758505710002, 776.47361234572156,
        778.14170527119313, 779.63373621083895, 780.98076500232287,
        782.08863201998736, 782.60893812098732, 782.3503010558361,
        782.48325249728032, 780.31842873161577, 778.89132932281916,
        778.04369616669965, 777.55018233755129, 774.76736365753175,
        766.29001204816188, 758.80832051407765, 751.85737589855364,
        746.74137221735373, 743.1446357896375, 739.09510082974805,
        736.58265777460497, 734.03509794084641, 732.85133087303461,
        727.68668057379023, 723.85602991647977, 719.30800641965322,
        716.46611821480246, 713.09649518591857, 708.04217500277355,
        701.6150769037431, 697.04881789386923, 693.06744844999946,
        691.29919221510045]

    def test_upc_period_6_upper_percent_6(self):
        period = 6
        upper_percent = 6
        upc = price_channels.upper_price_channel(self.data, period, upper_percent)
        np.testing.assert_array_equal(upc, self.upc_period_6_upper_percent_6_expected)

    def test_upc_period_8_upper_percent_3(self):
        period = 8
        upper_percent = 3
        upc = price_channels.upper_price_channel(self.data, period, upper_percent)
        np.testing.assert_array_equal(upc, self.upc_period_8_upper_percent_3_expected)

    def test_upc_invalid_period(self):
        period = 128
        with self.assertRaises(Exception):
            price_channels.upper_price_channel(self.data, period)

    def test_lpc_period_6_lower_percent_6(self):
        period = 6
        lower_percent = 6
        lpc = price_channels.lower_price_channel(self.data, period, lower_percent)
        np.testing.assert_array_equal(lpc, self.lpc_period_6_lower_percent_6_expected)

    def test_lpc_period_8_lower_percent_3(self):
        period = 8
        lower_percent = 3
        lpc = price_channels.lower_price_channel(self.data, period, lower_percent)
        np.testing.assert_array_equal(lpc, self.lpc_period_8_lower_percent_3_expected)

    def test_lpc_invalid_period(self):
        period = 128
        with self.assertRaises(Exception):
            price_channels.lower_price_channel(self.data, period)
