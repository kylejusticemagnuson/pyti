import unittest
import numpy as np

from sample_data import SampleData
from technical_indicators import double_smoothed_stochastic


class TestDoubleSmoothedStochastic(unittest.TestCase):
    def setUp(self):
        """Create data to use for testing."""
        self.data = SampleData().get_sample_close_data()

        self.dss_period_6_expected = [np.nan, np.nan, np.nan, np.nan, np.nan,
        np.nan, np.nan, np.nan, np.nan, np.nan, np.nan, np.nan, np.nan, np.nan,
        np.nan, 36.918928755433726, 21.691911120417267, 10.884420707119121,
        6.2468749255700775, 3.6971565602579108, 2.2672794330183472,
        5.4723137725051609, 15.274794862166678, 27.159851381108304,
        37.642119311147148, 47.234866707973353, 55.67116748445342,
        61.356620882704618, 60.23845244260346, 60.723337276442116,
        59.091086248970761, 52.166013265592049, 34.687679032344612,
        32.1065628807956, 40.588710613227327, 55.891068107498235,
        69.515837699306971, 76.778543526076376, 75.857484545644866,
        70.416827226349412, 63.7632107335413, 60.063348588131639,
        59.40438891404127, 62.551654109996804, 69.126185381746112,
        77.561715085436717, 85.294551288772908, 91.129372923888241,
        90.557121010672716, 84.854791821594446, 77.771425737621257,
        66.339994546918859, 48.272345223885672, 31.069630860637915,
        18.555091550180681, 14.298723930285826, 13.519890617011521,
        18.334863569223401, 20.685804438073692, 22.823928573649471,
        23.347488731428754, 22.436432081537991, 19.239195442362661,
        17.974593011483648, 19.264597185194596, 28.600511056532955,
        43.622681019065062, 50.480625900419874, 63.367697346298101,
        74.501301694861596, 71.706673032284257, 59.084543745215733,
        43.023746878337867, 32.420116143336024, 26.004975620769965,
        19.124376888341985, 14.247467641686626, 17.619831912084518,
        18.705168837878329, 28.000500772326742, 43.260140142807721,
        59.876707803096728, 66.751024151480749, 63.077685225168835,
        55.53289666671175, 46.068862629537847, 38.336746160451355,
        32.529103729785454, 28.19608766067152, 27.660941069461771,
        32.23005013304833, 41.37400132812423, 55.310729868369613,
        71.342181740620063, 84.718142723444004, 87.423963509881403,
        89.521947524042673, 90.979596388848208, 92.022796476656907,
        92.942135987830412, 92.40627848000419, 89.024850407480187,
        84.449841367648887, 65.64561236645244, 47.133779439162012,
        35.010155352752435, 28.956163331744193, 21.589518316893862,
        12.790370258147203, 7.6464598310338108, 4.5561419617656531,
        2.6138992067094984, 1.9262583704835881, 1.5700954727281256,
        2.3769399331415948, 2.9475742225632371, 3.4662008104616073,
        3.6131015064472081, 3.2436161738654481, 2.5228402216640076,
        3.244949741507436, 3.111306207915014, 2.7813327675044017,
        2.3261291904416228, 2.6786542266568287, 2.6023220348605225,
        4.4022396853664194]

        self.dss_period_8_expected = [np.nan, np.nan, np.nan, np.nan, np.nan,
        np.nan, np.nan, np.nan, np.nan, np.nan, np.nan, np.nan, np.nan, np.nan,
        np.nan, np.nan, np.nan, np.nan, np.nan, np.nan, np.nan,
        6.1025682984473368, 10.519461191700513, 16.490697504634248,
        22.316813234037937, 28.043920068019396, 34.850583646669996,
        42.699135129461055, 47.997044811176018, 53.38365941048756,
        56.389961322594239, 56.204549922237632, 49.886559678666117,
        46.294353185223372, 47.004523260740633, 54.207303371107884,
        64.203616079361964, 70.715713047259982, 71.423302253666847,
        70.076941893687646, 68.625371632447951, 68.455890646205759,
        69.27858593197702, 70.876629155624826, 72.5135525379482,
        75.024933874267802, 79.083917016742816, 83.890927291026145,
        86.471262117154112, 86.424224628248297, 85.198715362670328,
        81.904074403893802, 74.655384248721987, 64.346715719968188,
        52.169923234892124, 41.809064504701112, 33.585658682401522,
        28.637660022978345, 23.693637830044292, 20.393611009626074,
        18.12620255367834, 17.090507924154881, 16.285827370008029,
        16.107945276965189, 15.909339635536867, 18.503286282973004,
        24.686627292761596, 29.031172879549931, 37.584190058635208,
        48.287353114543286, 53.555951112440866, 52.790567577141992,
        47.703978043279264, 41.051811336758263, 35.67030945427274,
        29.468265156330236, 22.441097507392556, 19.8011176422734,
        17.438884222222338, 20.320833813805962, 27.812117318833479,
        37.593403834800284, 44.131921371561376, 47.174191624648124,
        47.543201067275938, 45.538946189523351, 44.042364049074159,
        40.723952696488055, 35.502239908110447, 31.397084709818806,
        30.186012525470858, 31.736946880973665, 36.09183736502483,
        43.517527224156105, 53.201460013857037, 61.920908895043304,
        71.782820210435446, 79.961626042609169, 86.009161316291369,
        90.122330008573542, 92.206966561217357, 91.561480831996462,
        90.186919152096678, 82.82890240254919, 72.438952011528073,
        61.965435827322665, 52.74377938109653, 41.32455883490789,
        26.710445804055055, 16.120475880496045, 9.5861178106924214,
        5.9746577623367081, 4.2080432521149111, 2.907394663932557,
        2.4384841764788945, 2.1752123691847034, 2.0418085577632432,
        1.9188883303737598, 1.8436794018149869, 1.7165007011686242,
        2.1766440196279051, 2.3972481260659917, 2.2236632769961076,
        1.8993957466544742, 1.9897683829820458, 1.930656760302548,
        2.9414192544694764]

        self.dss_period_10_expected = [np.nan, np.nan, np.nan, np.nan, np.nan,
        np.nan, np.nan, np.nan, np.nan, np.nan, np.nan, np.nan, np.nan, np.nan,
        np.nan, np.nan, np.nan, np.nan, np.nan, np.nan, np.nan, np.nan, np.nan,
        np.nan, np.nan, np.nan, np.nan, 29.378624448018471, 33.36996708142226,
        38.476274505682689, 42.844839829793436, 45.750260955752729,
        45.552412215794952, 45.905524038946602, 47.987505267657241,
        53.5407504799254, 60.640697255412576, 66.28838732679651,
        68.218692581346687, 67.820266973435949, 67.180708562200095,
        68.27219868517841, 70.467488702888076, 72.985303442060328,
        75.259909148994012, 77.35596695556066, 79.416373800781386,
        81.76846253327426, 83.644904041727202, 84.820232678214651,
        85.604236010646346, 85.075718781345969, 82.061129176904799,
        76.968722044325816, 70.419080384244936, 63.693077729610373,
        56.623617407517635, 50.360886146687321, 43.483790700571276,
        36.691165622557953, 30.273872592803709, 25.12302694280379,
        21.0589675378259, 18.483043779216992, 16.829683489320459,
        17.029170351288155, 19.083137422725443, 20.584258185309253,
        25.193564157816272, 32.249140598996121, 37.926557728819262,
        40.492919685990145, 40.220068674402718, 38.490838839603136,
        36.971192175404589, 33.171723972015911, 28.206078989528944,
        25.896598630377948, 22.304375945379572, 21.690197939445419,
        24.387341941658285, 29.359476606469592, 33.475888933414197,
        35.711655047078004, 36.14214745273118, 36.215644449011478,
        36.895687314890729, 36.831040739940477, 36.274748039642915,
        34.804082546835005, 33.110341866947834, 32.177991102003276,
        32.957361730890575, 35.983608563697864, 41.037966798004192,
        46.147234851330133, 52.161825789125203, 59.056959390628919,
        66.337003523228645, 73.369175118900543, 79.576816805614655,
        83.399904281389865, 85.821208962410637, 83.919620143113676,
        79.457327383164383, 74.128725245619648, 68.215223346932376,
        59.221901005385959, 44.733157757354682, 31.022184379801381,
        20.477149819934404, 13.347191065538762, 8.9965195343993933,
        6.2137633265232646, 4.7028169264946831, 3.5363102540205831,
        2.6392175662148616, 2.0550016374411317, 1.6965567303519808,
        1.4477294890250365, 1.615809129276879, 1.7093725954349597,
        1.6744886750264438, 1.5761022864547003, 1.5683468642632721,
        1.5040762672093719, 2.0565042626288541]

    def test_double_smoothed_stochastic_period_6(self):
        period = 6
        dss = double_smoothed_stochastic.double_smoothed_stochastic(self.data, period)
        np.testing.assert_array_equal(dss, self.dss_period_6_expected)

    def test_double_smoothed_stochastic_period_8(self):
        period = 8
        dss = double_smoothed_stochastic.double_smoothed_stochastic(self.data, period)
        np.testing.assert_array_equal(dss, self.dss_period_8_expected)

    def test_double_smoothed_stochastic_period_10(self):
        period = 10
        dss = double_smoothed_stochastic.double_smoothed_stochastic(self.data, period)
        np.testing.assert_array_equal(dss, self.dss_period_10_expected)

    def test_dss_invalid_period(self):
        period = 128
        with self.assertRaises(Exception):
            double_smoothed_stochastic.double_smoothed_stochastic(self.data, period)
